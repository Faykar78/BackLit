#!/bin/bash
set -e

MODULE_NAME="clevo-xsm-wmi"
MODULE_VERSION="1.0.0"
DKMS_SRC="/usr/src/${MODULE_NAME}-${MODULE_VERSION}"

# --- DKMS: Build and install kernel module ---
echo "→ Setting up DKMS kernel module..."

# Copy module source to DKMS source tree
if [ -d "/usr/share/backlit/clevo-xsm-wmi" ]; then
    mkdir -p "$DKMS_SRC"
    cp /usr/share/backlit/clevo-xsm-wmi/clevo-xsm-wmi.c "$DKMS_SRC/"
    cp /usr/share/backlit/clevo-xsm-wmi/Makefile "$DKMS_SRC/"
    cp /usr/share/backlit/clevo-xsm-wmi/dkms.conf "$DKMS_SRC/"

    # Remove old DKMS registration if present
    dkms status "$MODULE_NAME/$MODULE_VERSION" 2>/dev/null | grep -q "$MODULE_NAME" && \
        dkms remove "$MODULE_NAME/$MODULE_VERSION" --all 2>/dev/null || true

    # Register, build, and install via DKMS
    dkms add "$MODULE_NAME/$MODULE_VERSION" || true
    dkms build "$MODULE_NAME/$MODULE_VERSION" || { echo "⚠ DKMS build failed. Do you have linux-headers-$(uname -r) installed?"; }
    dkms install "$MODULE_NAME/$MODULE_VERSION" || { echo "⚠ DKMS install failed."; }
    echo "  ✓ Kernel module installed via DKMS"
else
    echo "  ⚠ Module source not found, skipping DKMS setup"
fi

# --- Systemd service: auto-load the module on boot ---
echo "→ Enabling kernel module autoload service..."
systemctl daemon-reload
systemctl enable clevo-xsm-wmi.service || true
systemctl start clevo-xsm-wmi.service || true
echo "  ✓ clevo-xsm-wmi service enabled"

# --- Load the module immediately ---
echo "→ Loading kernel module..."
# Remove conflicting modules
rmmod tuxedo_io 2>/dev/null || true
rmmod tuxedo_keyboard 2>/dev/null || true
rmmod clevo_wmi 2>/dev/null || true
rmmod clevo_acpi 2>/dev/null || true
# Load our module
modprobe clevo-xsm-wmi 2>/dev/null || insmod "/lib/modules/$(uname -r)/extra/clevo-xsm-wmi.ko" 2>/dev/null || \
    echo "  ⚠ Could not load module now. It will load on next reboot."
echo "  ✓ Module loaded"

# --- Udev + desktop ---
udevadm control --reload-rules && udevadm trigger
update-desktop-database /usr/share/applications || true

echo ""
echo "✅ BackLit installed successfully!"
echo "   Kernel module: clevo-xsm-wmi (via DKMS)"
echo "   Secure Boot must be DISABLED for the backlight to work."
echo "   Please log out and back in for hotkey permissions to take effect."
